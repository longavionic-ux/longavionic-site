<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>CATS Chat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      margin: 0;
      padding: 20px;
      font-family: Arial, Helvetica, sans-serif;
      background: #0f172a;
      color: #e5e7eb;
    }
    h2 { color: #38bdf8; margin-top: 0; }

    .top-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:8px;
      flex-wrap:wrap;
    }

    .left{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }

    .user { color: #94a3b8; margin-bottom: 6px; }
    .online { color:#94a3b8; font-size:13px; margin-bottom:6px; }
    .online b { color:#22c55e; }

    .cloud-status{
      font-size:12px;
      color:#64748b;
      margin-bottom:10px;
    }

    .chat-box {
      height: 320px;
      overflow-y: auto;
      border: 1px solid #1e293b;
      border-radius: 10px;
      padding: 10px;
      background: #020617;
      margin-bottom: 10px;
    }

    .msg { margin-bottom: 6px; font-size: 14px; }
    .msg b { color: #22c55e; }

    textarea {
      width: 100%;
      height: 60px;
      background: #020617;
      color: #e5e7eb;
      border: 1px solid #334155;
      border-radius: 6px;
      padding: 8px;
    }

    button {
      margin-top: 6px;
      margin-right: 6px;
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      background: #2563eb;
      color: white;
      cursor: pointer;
    }

    .btn-secondary{
      background:#334155;
    }
    .btn-secondary:hover{
      background:#475569;
    }
  </style>
</head>
<body>

<div class="top-row">
  <div class="left">
    <button class="btn-secondary" onclick="goBack()">Back</button>
    <h2 id="title">CATS Chat</h2>
  </div>
</div>

<div class="user" id="userInfo"></div>
<div class="online" id="onlineInfo"></div>
<div class="cloud-status" id="cloudStatus">Cloud: unknown</div>

<div class="chat-box" id="chat"></div>

<textarea id="input" placeholder="Type message..."></textarea>

<input type="file" id="fileInput" style="margin-top:6px;color:#94a3b8">

<br>
<button onclick="send()">Send</button>
<button onclick="sendFile()">Send File</button>

<!-- âœ… æ–°å¢ï¼šSocket.IO å®¢æˆ·ç«¯ï¼ˆå¿…é¡»ï¼‰ -->
<script src="http://34.55.16.228:3000/socket.io/socket.io.js"></script>

<!-- âœ… ç™»å½•æ€å…œåº•ï¼ˆä»…æ–°å¢è¿™ä¸€æ®µï¼Œä¸æ”¹ä»»ä½•æ—§é€»è¾‘ï¼‰ -->
<script>
  (function () {
    const u = sessionStorage.getItem("memberUser");
    if (!u) {
      alert("Session expired. Please login again.");
      window.location.href = "index.html";
    }
  })();
</script>

<script>
  /* ==================================================
     CONFIG
     ================================================== */
  const API_BASE = "http://34.55.16.228:3000";

  /* ==================================================
     ç”¨æˆ· & åˆ†ç»„ï¼ˆåŸæ ·ä¿ç•™ï¼‰
     ================================================== */
  const user = sessionStorage.getItem("memberUser") || "Guest";
  document.getElementById("userInfo").textContent = "Logged in as: " + user;

  const params = new URLSearchParams(window.location.search);
  const group = (params.get("group") || "general").toLowerCase();
  document.getElementById("title").textContent =
    "CATS Chat Â· " + group.toUpperCase();

  const chat = document.getElementById("chat");
  const key = "cats_chat_" + group;
  const onlineKey = "online_users_" + group;
  const onlineBox = document.getElementById("onlineInfo");
  const cloudStatus = document.getElementById("cloudStatus");

  function safeParseJSON(s, fallback) {
    try { return JSON.parse(s); } catch { return fallback; }
  }

  function escapeHtml(str) {
    return String(str)
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#39;");
  }

  /* ==================================================
     æœ¬åœ°åŠ è½½ï¼ˆå®Œå…¨ä¿ç•™ï¼‰
     ================================================== */
  function loadLocal() {
    chat.innerHTML = localStorage.getItem(key) || "";
    chat.scrollTop = chat.scrollHeight;
  }

  /* ==================================================
     äº‘ç«¯åŠ è½½ï¼ˆHTTP æ‹‰å†å²ï¼Œå…œåº•ï¼‰
     ================================================== */
  async function loadFromCloud() {
    try {
      const res = await fetch(API_BASE + "/api/chat?group=" + group, { cache: "no-store" });
      if (!res.ok) throw new Error("bad response");
      const list = await res.json();

      if (!Array.isArray(list)) return;

      let html = "";
      list.forEach(m => {
        if (m.type === "text") {
          html += `<div class="msg"><b>${escapeHtml(m.user)}:</b> ${escapeHtml(m.text)}</div>`;
        } else if (m.type === "file") {
          html += `<div class="msg"><b>${escapeHtml(m.user)}:</b><br>ğŸ“ <i>${escapeHtml(m.fileName)}</i></div>`;
        }
      });

      chat.innerHTML = html;
      localStorage.setItem(key, html);
      chat.scrollTop = chat.scrollHeight;
      // ä¸è¦åœ¨è¿™é‡Œå¼ºè¡Œå†™ realtimeï¼Œé¿å…è¯¯å¯¼
      if (!cloudStatus.textContent.includes("realtime")) {
        cloudStatus.textContent = "Cloud: synced (HTTP)";
      }
    } catch (e) {
      if (!cloudStatus.textContent.includes("realtime")) {
        cloudStatus.textContent = "Cloud: offline (local mode)";
      }
    }
  }

  /* ==================================================
     âœ… Socket.IO å®æ—¶å±‚ï¼ˆæ–°å¢æ ¸å¿ƒï¼Œä¸åˆ æ—§é€»è¾‘ï¼‰
     ================================================== */
  let socketOK = false;

  try {
    const socket = io(API_BASE, { transports: ['polling','websocket'] });

    socket.on('connect', () => {
      socketOK = true;
      socket.emit('join', { group, user });
      cloudStatus.textContent = "Cloud: realtime connected";
    });

    socket.on('disconnect', () => {
      socketOK = false;
      cloudStatus.textContent = "Cloud: synced (HTTP)";
    });

    socket.on('message', (m) => {
      // æ”¶åˆ°å®æ—¶æ¶ˆæ¯å°±è¿½åŠ ï¼Œä¸è¦†ç›–
      let html = "";
      if (m && m.type === "text") {
        html = `<div class="msg"><b>${escapeHtml(m.user)}:</b> ${escapeHtml(m.text)}</div>`;
      } else if (m && m.type === "file") {
        html = `<div class="msg"><b>${escapeHtml(m.user)}:</b><br>ğŸ“ <i>${escapeHtml(m.fileName)}</i></div>`;
      } else {
        return;
      }

      chat.innerHTML += html;
      localStorage.setItem(key, chat.innerHTML);
      chat.scrollTop = chat.scrollHeight;
    });
  } catch (e) {
    // socket åŠ è½½å¤±è´¥å°±é™é»˜ï¼Œä¿ç•™ HTTP + local
  }

  /* ==================================================
     å‘é€æ–‡å­—ï¼ˆæœ¬åœ° + äº‘ï¼‰
     ================================================== */
  async function send() {
    const input = document.getElementById("input");
    const text = input.value.trim();
    if (!text) return;

    const msgHTML =
      `<div class="msg"><b>${user}:</b> ${escapeHtml(text)}</div>`;

    // æœ¬åœ°ç«‹åˆ»æ˜¾ç¤ºï¼ˆä¿ç•™åŸä½“éªŒï¼‰
    chat.innerHTML += msgHTML;
    localStorage.setItem(key, chat.innerHTML);
    chat.scrollTop = chat.scrollHeight;
    input.value = "";

    try {
      const fd = new FormData();
      fd.append("user", user);
      fd.append("text", text);

      await fetch(API_BASE + "/api/chat?group=" + group, {
        method: "POST",
        body: fd
      });
    } catch (e) {
      console.warn("Cloud chat failed (local ok)", e);
    }
  }

  /* ==================================================
     å‘é€æ–‡ä»¶ï¼ˆæœ¬åœ° + äº‘ï¼‰
     ================================================== */
  async function sendFile() {
    const fileInput = document.getElementById("fileInput");
    const file = fileInput.files[0];
    if (!file) return;

    const sizeMB = (file.size / (1024 * 1024)).toFixed(2);

    const msgHTML =
      `<div class="msg">
        <b>${user}:</b><br>
        ğŸ“ <i>${escapeHtml(file.name)}</i> (${sizeMB} MB)
      </div>`;

    // æœ¬åœ°ç«‹åˆ»æ˜¾ç¤ºï¼ˆä¿ç•™åŸä½“éªŒï¼‰
    chat.innerHTML += msgHTML;
    localStorage.setItem(key, chat.innerHTML);
    chat.scrollTop = chat.scrollHeight;
    fileInput.value = "";

    try {
      const fd = new FormData();
      fd.append("user", user);
      fd.append("file", file);

      await fetch(API_BASE + "/api/upload?group=" + group + "&user=" + encodeURIComponent(user), {
        method: "POST",
        body: fd
      });
    } catch (e) {
      console.warn("Cloud file upload failed (local ok)", e);
    }
  }

  /* ==================================================
     è¿”å›é€»è¾‘ï¼ˆåŸæ ·ï¼‰
     ================================================== */
  function goBack() {
    const map = {
      setnix: "member-setnix.html",
      aero: "member-aero.html",
      skysmart: "member-skysmart.html",
      cats: "member-cats.html",
      general: "index.html"
    };
    window.location.href = map[group] || "index.html";
  }

  /* ==================================================
     åœ¨çº¿ç”¨æˆ·é€»è¾‘ï¼ˆâœ…è¿™æ®µå°±æ˜¯ä½ å°‘æ‰çš„ 50+ è¡Œï¼Œå®Œæ•´ä¿ç•™ï¼‰
     ================================================== */
  function updateOnline() {
    if (!user || user === "Guest") {
      onlineBox.textContent = "Online: (login required)";
      return;
    }

    const now = Date.now();
    const data = safeParseJSON(localStorage.getItem(onlineKey) || "{}", {});
    data[user] = now;

    const TTL = 90 * 1000;
    Object.keys(data).forEach(name => {
      if (now - data[name] > TTL) delete data[name];
    });

    localStorage.setItem(onlineKey, JSON.stringify(data));

    const list = Object.keys(data);
    onlineBox.innerHTML =
      list.length
        ? "Online (" + list.length + "): <b>" +
          list.map(escapeHtml).join("</b>, <b>") + "</b>"
        : "Online: (none)";
  }

  window.addEventListener("storage", (e) => {
    if (e.key === onlineKey) updateOnline();
  });

  window.addEventListener("beforeunload", () => {
    const data = safeParseJSON(localStorage.getItem(onlineKey) || "{}", {});
    delete data[user];
    localStorage.setItem(onlineKey, JSON.stringify(data));
  });

  /* ==================================================
     å¯åŠ¨
     ================================================== */
  loadLocal();        // å•æœºå…œåº•
  loadFromCloud();    // é¦–æ¬¡ HTTP åŒæ­¥
  updateOnline();

  setInterval(updateOnline, 10000);
  setInterval(loadFromCloud, 5000); // HTTP å…œåº•ï¼ˆå®æ—¶å¤±è´¥ä¹Ÿèƒ½åˆ·æ–°ï¼‰
</script>

</body>
</html>